"use strict";$.cloudinary.config().cloud_name="dqpknoetx",$.cloudinary.config().upload_preset="gec3tjz3",angular.module("nfolio",["ngCookies","ngResource","ngSanitize","ngRoute","firebase","cloudinary"]).constant("FIREBASE_URL","https://nfolio.firebaseio.com/").config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!0),a.when("/",{templateUrl:"views/photos.html",controller:"PhotoCtrl"}).when("/upload",{templateUrl:"views/photosUpload.html",controller:"PhotoUploadCtrl"}).when("/users/:username",{templateUrl:"views/profile.html",controller:"ProfileCtrl"}).when("/u/:username",{templateUrl:"views/profile.html",controller:"ProfileCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"AuthCtrl"}).when("/photos/:photoId",{templateUrl:"views/showphoto.html",controller:"PhotoViewCtrl"}).when("/register",{templateUrl:"views/register.html",controller:"AuthCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("nfolio").factory("Auth",["$firebaseSimpleLogin","FIREBASE_URL","$rootScope",function(a,b,c){var d=new Firebase(b),e=a(d),f={register:function(a){return e.$createUser(a.email,a.password)},signedIn:function(){return null!==e.user},login:function(a){return e.$login("password",a)},logout:function(){e.$logout()}};return c.signedIn=function(){return f.signedIn()},f}]),angular.module("nfolio").factory("User",["$firebase","$rootScope","FIREBASE_URL","Auth",function(a,b,c){function d(a){b.currentUser=g.findByUsername(a)}var e=new Firebase(c+"users"),f=a(e),g={create:function(a,b){f[b]={md5_hash:a.md5_hash,username:b,$priority:a.uid},f.$save(b).then(function(){d(b)})},findByUsername:function(a){return a?f.$child(a):void 0},getCurrent:function(){return b.currentUser},signedIn:function(){return void 0!==b.currentUser}};return b.$on("$firebaseSimpleLogin:login",function(b,c){var f=a(e.startAt(c.uid).endAt(c.uid));f.$on("loaded",function(){d(f.$getIndex()[0])})}),b.$on("$firebaseSimpleLogin:logout",function(){delete b.currentUser}),g}]),angular.module("nfolio").controller("ShowCtrl",["$rootScope","$scope","$location","$routeParams","$firebase","fbURL","Auth",function(a,b,c,d,e,f){var g=f+d.placeId;b.place=e(new Firebase(g)),b.placeId=d.placeId,b.postsuccess=!1,b.status="",b.postComment=function(a){var c=0;b.place.updated=(new Date).getTime();var d=new Firebase(f+b.placeId+"/feed");d.on("value",function(a){a.forEach(function(){c++})}),b.place.commentcount=parseInt(c)+1,b.place.$save();var e=new Firebase(f+b.placeId+"/feed"),g=e.push();g.set({message:a,updated:(new Date).getTime(),userid:b.currentUser}),b.status=""}}]),angular.module("nfolio").controller("EditCtrl",["$scope","$location","$routeParams","$firebase","fbURL","Auth",function(a,b,c,d,e){var f=e+c.placeId;a.place=d(new Firebase(f)),a.destroy=function(){var c=new AWS.S3;AWS.config.update({accessKeyId:"AKIAIUAB3DKYZOD3S7VQ",secretAccessKey:"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"}),AWS.config.region="eu-west-1";var d={Bucket:"nfolio",Delete:{Objects:[{Key:a.place.fileThumb},{Key:a.place.fileMedium}]}};c.deleteObjects(d,function(a,b){a?console.log(a,a.stack):console.log("DONE"+b)}),a.place.$remove(),b.path("/")},a.save=function(){a.place.$save(),b.path("/")}}]),angular.module("nfolio").directive("filelistBind",function(){return function(a,b,c){b.bind("change",function(b){a.$apply(function(){a[c.name]=b.target.files,console.log(a[c.name])})})}}),angular.module("nfolio").directive("checkUsername",["User",function(a){var b=/^[^.$\[\]#\/\s]+$/;return{require:"ngModel",link:function(c,d,e,f){f.$parsers.unshift(function(c){return b.test(c)?0===a.findByUsername(c).$getIndex().length?(f.$setValidity("taken",!0),f.$setValidity("invalid",!0),c):(f.$setValidity("taken",!1),void f.$setValidity("invalid",!0)):(f.$setValidity("taken",!0),void f.$setValidity("invalid",!1))})}}}]),angular.module("nfolio").factory("album",["$rootScope","$resource",function(a,b){var c=$.cloudinary.url("nfolio",{format:"json",type:"list"});return c=c+"?"+Math.ceil((new Date).getTime()/1e3),b(c,{},{photos:{method:"GET",isArray:!1}})}]).factory("Photo",["$firebase","User","FIREBASE_URL",function(a,b,c){var d=new Firebase(c+"photos"),e=a(d),f={all:e,create:function(a){if(b.signedIn()){var c=b.getCurrent();return a.owner=c.username,e.$add(a).then(function(a){var b=a.name();return c.$child("photos").$child(b).$set(b),b})}},find:function(a){return e.$child(a)},remove:function(a){if(b.signedIn()){var c=f.find(a);c.$on("loaded",function(){var d=b.findByUsername(c.owner);e.$remove(a).then(function(){d.$child("photos").$remove(a)})})}},edit:function(){},addComment:function(a,c){if(b.signedIn()){var d=b.getCurrent();c.username=d.username,c.photoId=a,c.updated=(new Date).getTime(),e.$child(a).$child("comments").$add(c).then(function(b){d.$child("comments").$child(b.name()).$set({id:b.name(),photoId:a})})}},deleteComment:function(a,c,d){if(b.signedIn()){var e=b.findByUsername(c.username);a.$child("comments").$remove(d).then(function(){e.$child("comments").$remove(d)})}}};return f}]),angular.module("nfolio").filter("hostnameFromUrl",function(){return function(a){var b=document.createElement("a");return b.href=a,b.hostname}}),angular.module("nfolio").controller("AuthCtrl",["$scope","$location","Auth","User",function(a,b,c,d){c.signedIn()&&b.path("/"),a.$on("$firebaseSimpleLogin:login",function(){b.path("/")}),a.login=function(){c.login(a.user).then(function(){b.path("/")},function(b){a.error=b.toString()})},a.register=function(){c.register(a.user).then(function(c){d.create(c,a.user.username),b.path("/")},function(b){a.error=b.toString()})}}]),angular.module("nfolio").controller("ProfileCtrl",["$scope","$routeParams","Photo","User",function(a,b,c,d){function e(){a.photos={},angular.forEach(a.user.photos,function(b){a.photos[b]=c.find(b)})}function f(){a.comments={},angular.forEach(a.user.comments,function(b){var d=c.find(b.photoId);d.$on("loaded",function(){a.comments[b.id]=d.$child("comments").$child(b.id),a.commentedPhotos[b.photoId]=d})})}a.user=d.findByUsername(b.username),a.commentedPhotos={},a.user.$on("loaded",function(){e(),f()}),a.timeAgo=function(){return moment(ms).fromNow()}}]),angular.module("nfolio").controller("NavCtrl",["$scope","$location","Photo","Auth",function(a,b,c,d){a.logout=function(){d.logout()}}]),angular.module("nfolio").controller("PhotoUploadCtrl",["$scope","$rootScope","$routeParams","$location","Photo",function(a,b,c,d,e){a.photo={title:"",description:"",image:"",file:"",updated:(new Date).getTime()},a.timeAgo=function(a){return moment(a).fromNow()},a.submitPhoto=function(){e.create(a.photo).then(function(){a.photo={title:"",description:"",image:"",file:"",updated:(new Date).getTime()}})},a.deletePhoto=function(a){e.remove(a)},a.editPhoto=function(a){e.edit(a)},a.widget=$(".cloudinary_fileupload").unsigned_cloudinary_upload($.cloudinary.config().upload_preset,{tags:"nfolio",context:"photo="},{dropZone:"#direct_upload",start:function(){a.status="Starting upload...",a.$apply()},fail:function(){a.status="Upload failed",a.$apply()}}).on("cloudinaryprogressall",function(b,c){a.progress=Math.round(100*c.loaded/c.total),a.status="Uploading... "+a.progress+"%",a.$apply()}).on("cloudinarydone",function(c,d){b.photos=b.photos||[],d.result.context={custom:{photo:a.title}},a.photo.file=d.result.path,a.photo.metadata=d.result.image_metadata,a.result=d.result,b.photos.push(d.result),a.$apply()})}]).controller("PhotoCtrl",["$routeParams","$scope","$location","Photo",function(a,b,c,d){"/"===c.path()&&(b.photos=d.all),b.photo={title:"",description:"",image:"",updated:(new Date).getTime()},b.timeAgo=function(a){return moment(a).fromNow()},b.addComment=function(a){d.addComment(a,b.comment),b.comment=""},b.submitPhoto=function(){d.create(b.photo,b.files).then(function(){b.photo={title:"",description:"",image:"",updated:(new Date).getTime()}})},b.deletePhoto=function(a){d.remove(a)},b.editPhoto=function(a){d.edit(a)}}]),angular.module("nfolio").controller("PhotoViewCtrl",["$scope","$routeParams","Photo",function(a,b,c){a.photo=c.find(b.photoId),a.addComment=function(){c.addComment(b.photoId,a.comment),a.comment=""},a.removeComment=function(b,d){c.deleteComment(a.photo,b,d)}}]),angular.module("nfolio").controller("PhotoEditCtrl",["$scope","$routeParams","Photo",function(a,b,c){a.photo=c.find(b.photoId),a.editPhoto=function(){c.edit(a.photo,b.photoId)}}]),angular.module("nfolio").directive("imageResize",["$parse",function(a){return{link:function(b,c,d){var e;e=a(d.imagePercent)(b),c.bind("load",function(){c.unbind("load");var a,b,d,f;d=c[0].naturalHeight*e/100,f=c[0].naturalWidth*e/100,a=document.createElement("canvas"),a.width=f,a.height=d,b=a.getContext("2d"),b.drawImage(c[0],0,0,f,d),c.attr("src",a.toDataURL("image/jpeg"))})}}}]);